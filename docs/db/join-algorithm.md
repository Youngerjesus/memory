## 결합 알고리즘과 성능

옵티마이저가 선택하는 결합 알고리즘은 크게 3가지가 있다.

- Nested Loop

  - Nested Loop 는 중첩 반복문을 사용하는 구조다. SQL 에서는 한번의 두개의 테이블을 결합시키는게 가능하고
  결합을 시작하는 테이블을 외부 테이블, 구동 테이블이라고 하고 결합 당하는 테이블을 내부 테이블이라고 한다. 
  
  - 과정은 Outer Table 에서 하나씩 레코드를 읽고 그거와 조인할 수 있는 테이블을 Inner Table 에서 찾는 구조다. 
  
  - 그러므로 데이터의 탐색은 Outer Table 의 사이즈인 R(A) 와 Inner Table 의 사이즈인 R(B) 를 곱합 R(A) * R(B) 값 만큼
  데이터를 탐색하게 되고 가지고오게 될 수도 있다.
  
  - Nested Loop 의 장점은 이후에도 계속 설명하겠지만 OLTP (사용자의 요청에 대한 실시간 반영) 환경에서 적합하고 
  Hash 나 Sort Merge 보다 탐색하는 데이터는 많지만 한번의 데이터 탐색에 대한 메모리 사용량은 적다.  
  
  - Nested Loop 에서 중요한건 Outer Table 의 사이즈를 적은 쪽에서 조인을 시작하는 건데 그 조건으로는 
  조인이 인덱스로 걸려 있어야 한다는 것이다. 조인이 인덱스로 걸려있고 equal 조건으로 내부 테이블에서 찾는거라면
  인덱스를 통해 바로 검색할 수 있으니까 탐색해야하는 데이터 사이즈가 R(A) * 2 정도의 크기로 줄어든다.
  이렇게 하고 실행 계획을 보면 내부 테이블을 조사할 때 Index_Unique_Scan 이 된다. 이렇게 하지않으면 Table Full Scan
  이 될 수 있다. 
  
  - OneToMany 관계에서 Nested Loop 로 데이터를 탐색하는 경우에 Outer Table 이 One 이 되고 
  Inner Table 이 Many 가 되도록 설계할 것인데 Many 가 아주 많다면 히트될 확률이 높으니까 테이블 풀 스캔이랑
  그렇게 큰 차이가 없을 것이다. 즉 성능이 안나올건데 이런 경우 OLTP 상황이 아니라면 결합 알고리즘을 사용하는 것도 가능하고
  커버링 인덱스를 사용하는 것도 고려해볼만하다. 
  
- Hash 

  - Hash Join 은 일단 작은 테이블 쪽을 쭉 스캔하면서 FK 를 키로 해시 테이블로 올리고 큰 테이블을 이후에 스캔하면서
  연결된 키를 해시테이블 검색을 통해서 결합하는 알고리즘으로 데이터 탐색의 수는 R(A) + R(B) 가 된다. 
  탐색할 데이터 수는 적어지지만 작은 테이블 쪽을 모두 메모리 상으로 옮기므로 메모리 사용량이 많다.
  그러므로 워킹 메모리 보다 항상 올라가는게 작은지 체크해야한다.    
  
  - 메모리를 많이 사용하므로 OLTP 상황에서는 메모리가 부족할 수 있으므로 I/O 가 많아진다. 그러므로 지연시간이 길 수도 있어서
  OLTP 상황에서는 부적합하다. 배치 처리 상황에서는 좋을 수 있다. 
  
  - Hash Join 은 그리고 equals 비교에서만 사용이 가능하다. 정렬된게 아니므로 부등호 연산에서는 불가능하다.
  
  - Hash Join 은 Outer Table 의 수가 적고 Inner Table 의 수가 많은 경우에 Nested Loop 보다 성능상으로 우수하다.
  
  - Nested Loop 의 내부 테이블에 인덱스가 존재하지 않는 경우에 (여러가지 사정이 있는 경우) 에 적합하다. 
  
- Sort Merge 

  - Sort Merge 는 Merge Join 이라 부르기도 하고 결합 키를 기준으로 양쪽 테이블을 정렬한 후 일치하는 결합키를 찾으면
  결합하는 구조다. 
  
  - 대상 테이블을 모두 정렬해야하니까 확실히 메모리에 Hash Join 보다 값이 많이 올라온다. 그러므로 메모리 사용에 주의해야겠다.
  
  - Hash 와는 다르게 equals 연산 뿐만 아니라 부등호 연산에도 사용할 수 있다. 
  

옵티마이저가 결합 알고리즘을 선택하는 요인은 데이터의 크기와 결합키의 분산을 보고 주로 결정한다.

주로 대부분의 알고리즘은 Nested Loop 를 쓰게되고 대부분의 DBMS 는 이 3가지의 알고리즘을 지원하지만 MySQL
은 Nested Loop 계열의 파생 알고리즘만 지원하지 Hash 나 Sort Merge 는 지원하지 않는다.  
(하지만 실제 MySQL 8.0.18 버전 레퍼런스에서는 Hash Join 을 지원하는 걸로 나와있다.)



## IoC Container 

객체를 생성해주고 의존관계를 엮어주는 컨테이너

@ComponentScan 으로 내가 만든 객체를 빈으로 등록해주고

@EnableAutoConfiguration 으로 라이브러리들을 빈으로 등록해준다. 

#### IoC (Inversion of Control) 제어의 역전

내가 의존성들을 연결 시켜주는게 아니라 스프링 같은 프레임워크 단에서 연결 시켜주는 걸 말한다. 

IoC 를 함으로써 객체는 의존성 연결에는 신경쓰지 않아도 되고 자신이 수행해야 할 로직에만 집중하면 된다. 

프로그램의 제어의 흐름, 의존성의 연결을 시켠쓰지 않아도 된다. 

#### 프레임워크와 라이브러리

내가 코드를 가지고와서 사용햐는 건 라이브러리. 

내 코드를 다루는 역할을 하는게 프레임 워크

#### DI 의 좋은점 

객체지향 프로그래밍에서 신경써야 할 요소가 SOLID 라는 원칙이 있다.

DI 를 하면 여기에 있는 원칙들을 기준으로 더 나은점을 제공해준다.

SRP - 단일 책임의 원칙

- 객체 생성의 책임을 지지 않아도 된다. 자신이 실행하는 로직에만 신경쓰면 된다.

OCP - 개방 폐쇄 원칙

- 역할에 의존하도록 인터페이스에 의존하도록 하고 실제 구현 객체에 의존하지 않아도 된다. 
구현 객체가 개선되던지 바뀌던지 신경쓰지 않아도 된다. 변경에 닫혀있다. 

DIP 

- 마찬가지로 인터페이스에 의존하도록 할 수 있다. 

#### ApplicationContext 와 BeanFactory

BeanFactory 가 스프링 컨테이너의 최상위 인터페이스로 빈을 관리하고 등록하는 역할을 한다.

ApplicationContext 는 빈 팩토리 이외에도 부가적인 기능을 좀 더 한다. 메시지 국제화, 환경 변수를 관리하는 것, 애플리케이션 이벤틀르 발행하고 구독하는 것, 클래스 패스나 외부에서 리소스를 편리하게 조회하도록 하는 것

#### 스프링 빈 등록방법 

스프링에서는 빈을 등록할 때 XML 형식이나 자바 코드로 등록할 수 있다. 이처럼 다양하게 등록할 수 있는 이유는 역할과 구현을 구분했기 때문에.

결국에는 BeanDefinition 이라는 역할에 의존한 정보만 가져오면 된다. BeanDefinition 이란 빈을 등록하기 위한 정보들을 가지고 있다. 이를 바탕으로 빈으로 등록한다.

BeanDefinition 정보

- BeanClassName : 생성할 빈의 클래스 이름

- factoryBeanName: 팩토리 역할을 하는 빈의 이름 (Configuration File 같은 걸 말한다.)

- factoryMethodName : 팩토리 역할을 하는 빈에서 빈으로 등록해주는 메소드 이름

- Scope: 스코프 (싱글톤의 기본이고 매번 다른 객체가 생성되는 프로토 타입이 있다.)

- LazyInit : 스프링 컨테이너를 생성할 때 빈을 생성하는게 아니라 실제 사용할 때 빈으로 등록할지의 여부를 말한다. 

- DestroyMethodName: 빈의 생명주기 메소드로 빈이 죽을때 실행할 메소드 이름 

- Constructor arguments : 의존관계 주입에서 사용되는 매개변수들을 말한다. 


#### 왜 빈을 싱글톤으로 하는 것일까? 

매 번 사용자의 요청마다 인스턴스를 생성한다고 생각하면 메모리 사용량이 커진다. 

반복되고 상태가 필요없는 객체라면 재사용하는게 효율적이기 때문에 싱글톤으롯 사용한다.  

#### 그렇다면 싱글톤의 단점은 뭘까? 

싱글톤으로 만드는 방법은 다양하고 만들기 위해서 사용하는 코드가 있다. 코드의 반복되는 작업을 해줘야 한다는 점이고

싱글톤으로 만들때 결국엔 실제 구현 객체를 넣어줘야 하는데 그러면 DIP 나 OCP 를 위반할 수 있다. 

#### 싱글톤으로 만들 때 주의할 점

객체를 외부에서 생성하지 못하도록 할 것. 상태에 의존하지 않도록 할 것.


#### 스프링에선 싱글톤으로 보장하기 위해서 어떻게 할까? 

@Configuration 파일을 이용해서 빈으로 등록하는데 이떄 new 키워드를 통해서 객체를 생성해준다. 이는 싱글톤이 아니다. 어떻게 그러면 싱글톤으로 만드는가? 

- CGLIB 라는 바이트코드 조작 라이브러리를 이용해서 싱글톤으로 만들어준다. 

#### @ComponentScan

@Component 에노테이션이 붙은 클래스를 스프링 빈으로 등록해준다. 그리고 @ComponentScan 이 붙은 클래스를 기준으로 하위 패키지까지 모두 조사해준다. 

패키지를 조사해줄때 필터를 이용해서 컴포넌트 스캔 대상을 추가해주거나 제외 해주는게 가능하다.  

이때 등록해주는 빈의 이름은 직접 지정한 경우에는 그걸 쓰지만 그렇게 하지 않았다면 첫글자는 소문자로 지정해서 등록해준다. 

빈의 조회 전략은 타입을 기반으로 조회한다. 

#### 조회할 빈이 두 개 이상이라면? 

@Autowired 를 통해 의존성을 주입할 때 먼저 타입 매칭을 시도하는데 이때 빈이 여러가지 있으면 필드 이름이나 파라미터 이름으로 추가 매핑한다. 

만약 이름을 바꾸기 싫다면 @Qualifier 를 통해서 빈을 등록하고 @Qualifier 이름을 통해서 빈을 찾고 매핑하도록 할 수 있다. 

@Qualifier 로 못찾을 경우에 그 이름을 기반으로 빈을 찾고 이때도 못찾으면 NoSuchBeanDefinition 예외가 발생한다.

@Qualifier 로 찾는 방법 말고 @Primary 를 통해서 의존성 주입할 때 우선순위를 주는 방법도 있다. 

조회할 빈이 모두 필요하다면 List 형식이나 Map 형식으로 받을 수도 있다. 

#### @Primary 와 @Qualifier 언제 쓰는가? 

메인 데이터베이스 커넥션과 특별한 기능을 위해 서브 데이터베이스 커넥션이 있다고 생각해보면 대부분은 메인 데이터베이스 커넥션을 쓰므로 @Primary 에노테이션을 붙여놓고

서브 데이터베이스 커넥션이 필요한 경우에는 @Qualifier 를 붙여서 쓰면 된다.
  
#### 빈 생명주기 콜백 

데이터베이스 커넥션이나 네트워크 소켓 연결과 같이 애플리케이션 시작할 때 연결하고 종료할 때 제거해주는 작업이 필요한 경우에 빈 생명주기를 사용하면 좋다.

스프링 빈의 라이프 사이클은

스프링 컨테이너가 생성되면 빈 객체를 만들고 의존성을 주입해준다. 그 이후 초기화 콜백을 제공해주고 스프링 컨테이너가 종료되기 전에 종료 콜백도 제공해준다.

#### 초기화 콜백과 생성자

빈 초기화 콜백을 사용하지말고 생성자를 이용하면 안되냐라고 물을 수 있는데 생성자와 초기화 콜백은 애초에 관심사가 다르다. 생성자는 빠르게 객체를 생성하고
메모리위에 올려놓는게 목표라면 초기화는 그보다 좀 더 무거운 작업을 필요로 한다. 이 부분이 좀 더 유지보수 관리 측면에서 좀 더 좋다.

#### 스프링이 제공하는 3가지 빈 생명주기 콜백 메소드

1. InitializingBean 과 DisposalBean 인터페이스

- 이 방법은 스프링 전용 인터페이스를 이용하므로 이름을 변경할 수 없다. 라는 특징이 있다. 스프링에 지나치게 종속적이다 라는 특징이 있다.

2. @Bean 으로 만드는 설정 정보에 초기화, 종료 메소드를 지정하는 방법

- 이 방법도 스프링에서 빈을 만들 때 초기화와 종료 메소드를 지정하는 방법이다. 

3. @PostConstruct 와 @PreDestroy 에노테이션

- 마지막으로 이 방법은 스프링이 아닌 자바 진영에서 제공해주는 에노테이션으로 스프링이 아닌 다른 컨테이너에서도 잘 작동한다. 스프링에 의존적이지 않아도 된다라는
장점이 있다.

#### 빈 스코프란? 

스프링 자체는 다양한 스코프를 제공해준다. 

싱글톤 스코프: 스프링 컨테이너의 시작과 종료까지 함께하는 스코프를 말한다.

프로토 타입 스코프: 스프링 컨테이너가 빈의 생성과 의존관계 주압 초기화 까지만 관련해주는 스코프를 말한다. 빈이 제거될때 종료될 때 실행되는 콜백 메소드 같은 건 지원해주지 않는다.
사용자 책임이니까. 초기화 메소드도 싱글톤은 스프링 컨테이너가 켜질 때 한번만 실행하지만 프로토 타입은 빈이 조회될 때 그때 생성하고 의존성 주입하고 초기화 실행한다. 

이외에도 웹과 관련된 스코프도 제공해준다.

- Request: 웹 요청이 들어오고 나갈때까지 유지되는 스코프를 말한다.

- Session: 웹 세션이 시작되고 종료될 때 까지 유지되는 스코프를 말한다.

- Application: 웹의 서블릿 컨택스트와 같은 스코프를 말한다.

- webSocket: 웹 소켓과 동일한 생명주기를 가지는 스코프를 말한다. 

스코프를 등록할 땐 @Component 에노테이션 위에다가 @Scope 를 붙이면 된다. 

프로토타입 스코프를 사용할 땐 싱글톤 타입의 빈이 내부에서 프로토 타입의 빈을 사용하는 경우에 주의해야하는데 이렇게 사용하는 경우에는

매 요청의 순간마다 새로운 프로토 타입의 빈이 생겨나는 걸 원하겠지만 싱글톤 빈은 한번 생성되고 컨테이너가 죽을떄까지 쭉 주의해야한다. 

이를 해결하기 위해서는 요청을 받을때마다 내가 원하는 프로토타입의 빈을 찾아서 달라는 Dependency Look up 이 필요하다. 이를 위해 Object Provider 를 사용하면 되고

이 ObjectProvider 에게 빈을 달라고 요청하면 된다.
 
만약 스프링이 아니라 다른 컨테이너도 사용을 고려한다면 자바 진영에서 제공해주는 Provider 도 있으니까 이걸 사용하면 된다. 

#### 로그와 관련된 팁

웹과 관련된 부분은 가급적 컨트롤러 레벨에서만 지원하고 서비스 계층은 순수하게 유지하는것이 유지보수 측면에서 좋다. 




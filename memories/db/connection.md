## Database Connection

https://www.youtube.com/watch?v=6Q7iRTb4tQE

***

#### DB 커넥션 풀

용어 절리를 먼저 하자면 커넥션 풀에서 이미 사용중인 커넥션은 `In Use 커넥션` 이라고 하고 풀 안에서 사용중이지 않은 커넥션을 `Idle 커넥션` 이라고 한다.

커넥션을 사용하는 이유는 다음과 같다.

- 커넥션을 일회용성으로 사용하기에는 객체의 생성과 커넥션을 매번 새로 맺기는 비싸다. 

- 커넥션을 만들어놓고 사용한다면 생성하는 시간을 줄일 수 있으니까 그 만큼 네트워크 시간도 줄어든다. 

- 일정한 개수의 커넥션만을 사용한다면 DB 에 줄 수 있는 최대 부하를 설정할 수 있다. 그러므로 너무 오버해서 DB 를 사용하지 않을 수 있다.
즉 DB 성능을 포화해서 사용하지 않을 수 있다. 


#### DB 커넥션 설정

스프링 부트의 Hikari 를 기준으로 설정 값을 보겠다.

- 최대 커넥션 개수: maximumPoolSize 

  - 풀이 제공할 수 있는 최대 커넥션 개수를 말한다. (사용 중 + 유휴 커넥션) 
  
  - 이 설정에 따라서 낼 수 있는 최대 TPS 가 설정된다. 
  
    - 최대 TPS: 1개 커넥션의 초당 요청 처리 수 * 동시 커넥션 개수 
    
  - 최대 TPS 를 고려할려면 늘 슬로우 쿼리를 생각해야한다. 느린 쿼리 때문에 TPS 가 급격히 떨어진다. 왜냐하면 TPS 를 설정할 때 1개의 커넥션이 한 요청을 처리하는데 얼마나 시간이 걸리는지를 바탕으로 계산을 하기 때문이다.
  
- 커넥션 대기 시간: connectionTimeout 

  - 풀에서 커넥션을 구하기 위해 대기하는 시간을 말한다. 즉 풀애서 모든 커넥션이 사용중일 때 요청은 커넥션을 기다리는 대기가 발생한다.
  
  - 기본 값은 너무 큰 30초가 된다. 즉 순간적인 트래픽이 몰려서 모든 커넥션이 사용중이라면 각 요청의 스레드는 30초 동안 커넥션을 기다리는 대기가 
  발생할 수 있다. 이렇게 긴 응답보다는 에러화면을 보여주는게 더 낫다. 
  
  - 응답 시간이 중요한 경우에는 이 값을 1초 ~ 3초로 설정하는게 좋다. 
  
- 커넥션 최대 유지시간: maxLifetime

  - 커넥션을 생성한 이후 이 시간이 지나면 커넥션을 닫고 풀에서 제거한다. 그 후 커넥션을 새로 생성한다.  
  
  - 이 값의 설정은 네트워크나 DB 관련 설정보다 작은 값을 사용하는게 좋다 라는 것이다. 
  
    - 예로 최대 TCP 커넥션 유지시간보다 작은 값을 설정하는게 좋다. 만약애 이 값이 TCP 커넥션보다 값이 크다면 TCP 연결은 끝났는데 
    DB 커넥션은 계속 남아 있으므로 쓸모없는 커넥션을 가지게 된다. 이로 인해 이 커넥션을 사용하려고 할 때 유효한지 검사하게 되고
    그 과정에서 유효하지 않은 커넥션이라고 판단하므로 새로 생성하게되고 이로인해 TPS 가 떨어지게 된다.
    
- 커넥션 확인 주기: keepAliveTime

  - 커넥션이 살아있는지 확인하는 주기이다. 
  
  - 즉 커넥션은 유효하지 않을 수 있다. 최대 TCP 연결 시간이 지난 경우라던지, 커넥션을 만들었지만 활동하지 않는다던지 등등의 이유로 
  이렇게 활동하지 않은 커넥션은 제거해야한다.  
  
  - 커넥션이 활동하지 않아서 끊길만한 시간보다 작도록 설정한다.  
  
    - 유휴 커넥션이 살아있는지 확인하고 유휴하지 않은 커넥션은 풀에서 제거한뒤 새로 생성하는 역할을 한다. 
    
    - 이 설정은 DB 에 있는 설정 중에 일정시간 동안 쿼리를 날리지 않는 커넥션 같은 경우는 닫는 설정 값이 있다면 이 값보다 작은 값을 선택하는게 좋다.
    
- 최소 유휴 커넥션의 개수: minimumIdle

  - 풀에서 유지할 최소 유휴 커넥션 개수를 말한다.   
  
  - 설정하지 않는다면 maximumPoolSize 와 동일하다. 
  
  - Hikari 문서에서는 이 값을 설정하지 않는 걸 추천한다. 이 값이 작다면 급격한 트래픽 증가에 대응하기가 어렵다.
  대신에 이 값 설정을 하면 트래픽이 작을 때 DB 자원을 아낄 수 있다 라는 장점이 있다.
  
- 최대 유휴 시간: idleTimeout 

  - 커넥션이 사용 되지 않고 풀에서 머무를 수 있는 시간을 말한다. 
  
  - 이 규칙은 minimumIdle 이 maximumPoolSize 보다 작은 값일때 사용된다. 
  
  - 즉 minimumIdle 과 같이 사용되는 설정 값이다. 트래픽이 빠지는 시간을 기준으로 이 값을 사용하면 된다. 
  
   
   
 
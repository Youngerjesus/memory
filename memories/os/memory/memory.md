## Memory

#### 메모리가 관리되는 방법

컴파일러에 의해 우리가 사용하는 변수가 Symbolic Address 에서 Logical Address 로 매핑된다.(Logical Address 는 상대적인 주소)

논리적인 주소는 다들 0번 부터 시작한다. 상대적인 주소기 떄문에.

상대적인 주소를 이용하기 때문에 실제 주소와 연결해주는 녀석이 필요하다. 그게 바로 MMU(Memory Management Unit)

현대적인 메모리 관리에서는 페이징을 기반으로 메모리를 관리한다. 페이징은 프레임이라는 메모리를 일정한 크기로 잘린 녀석이 있는데 
이 크기와 동일한 사이즈로 프로세스를 자르고 필요한 녀석만 메모리에 올리고 나머지는 디스크나 스왑 영역에 저장해두고 사용한다.
이렇게 사용하는걸 가상 메모리라고 한다. 

그렇기 때문에 프로세스의 페이지가 메모리 어디에 있는지, 메모리에 올라가 있는지 등을 MMU 에게 알려줘야 하는 정보가 필요한데 이를 페이지 테이블이라고 한다. 

페이지 테이블에는 메모리의 어느 프레임에 있는지, 메모리가 적재되어 있는지, 이후에 설명할 메모리가 페이지 폴트로 인해서 최근에 참조된 적이 있는지, 
메모리에서 디스크에 변경사항을 반영해야 하는지    
 
TLB 미스가 나면 페이지 테이블들을 메모리에서 찾아서 가지고 와서 판단하는건가?
- 페이지 테이블들이 어디에 있는지 알고.
  - PTBR(Page-table base register) 레지스터가 페이지 테이블의 주소를 가리키고 PRLR(Page-table length register) 가 페이지 테이블의 사이즈를 말해준다.

##### TLB 가 소유하고 있는 Page Table Entry 는 어떻게 구성되어 있는가?

- Process ID -  Page - Frame - Access 이렇게 구성되어 있다. 그래서 Process Id 가 매칭되어야 한다. 


##### PTBR, PRLR 이 둘의 레지스터는 PCB 에 저장되는가?

- ㅇㅇ

- PCB 에 PTBR 이 저장된다면 MMU 는 PTBR 에 있는 주소로 가서 페이지 테이블을 가져오고 그 페이지 테이블에 있는 주소를 기반으로 
  물리 주소를 만들어주는건가?     

##### TLB 를 사용하는 이유는? 

- 페이지 테이블을 사용하게 되면서 메모리 엑세스가 두번씩 일어나게 된다. 
  
  1. 페이지 테이블을 가져와라
  
  2. 페이지 테이블을 기반으로 메모리 매핑해서 메모리에 있는 데이터 가져오기.  

##### TLB Miss 가 난다면

1. MMU 에서 페이지 테이블 주소를 가지고 있는 레지스터 값을 통해서 페이지 테이블을 가지고 온다.

2. 해당 페이지 테아블을 통해서 TLB 를 업데이트 해주고 데이터를 가지고 온 다음 CPU 에게 전달해준다. 


#### Page Fault 

메모리에 페이지가 적재되어 있지 않다면 보조 기억 장치(Disk) 에서 페이지를 가지고 온 다음 페이지 테이블을 업데이트 해줘야 한다. 

페이지 폴트가 일어나면 I/O 작업이 일어나기 떄문에 CPU 는 다른 작업을 할 수도 있다. 

#### Page Replacement 

Page Fault 가 자주 발생해서 결국에 물리 메모리에 페이지가 가득차게되면 덜쓰는 페이지를 찾아서 페이지를 스왑 영역에 내리고 사용할 페이지를 메모리에 적재해야한다.

이때 덜쓰는 페이지를 찾기 위해서 페이지 교체 알고리즘이 필요한데 LRU 같은 가장 덜 쓴 페이지를 찾아서 교체하는게 성능상으론 가장 좋겠지만 그러기 힘들기 때문에 LRU 와 비슷한 Clock Algorithm 을 사용한다. 

페이지 폴트가 일어나면 최근에 참조했단 뜻으로 reference bit 를 1 로 설정해놓는 걸 통해서 최근에 사용한 페이지들은 넘어가고 
이 reference bit 를 0으로 바꾸는 걸 통해서. reference bit 가 0 인 페이지를 교체한다.

이때 쫒아낼때 이 페이지가 디스크에 반영해야 할 사항들이 있다면 (Dirty 비트가 1인 경우라면) 디스크에 반영을 하고 교체한다.   

#### Page Replacement 나 Page Fault 가 자주 발생하는 경우

다양한 프로세스를 많이 사용하다 보면 메모리에는 다양한 프로세스의 페이지가 올라오고 이 경우에 Page Fault 나 Page Replacement 가
자주 발생해 I/O 가 높아지고 이로인해 CPU 효율이 떨어지는 상황이 발생한다. 

이를 Thrashing 이라고 한다.  


#### Thrashing 을 해결하는 방법

Thrashing 을 해결하기 위해서 Working Set 알고리즘과 Page Fault Frequency 알고리즘을 이용한다.  

Working Set 알고리즘

- 이 알고리즘은 대부분 프로세스가 특정한 페이지를 자주 사용한다는 근거에 의해서 시작한 알고리즘인데 관련있는 페이지를 한번에 묶어서 적재하는 걸 말한다.

Page Fault Frequency 알고리즘 

- 페이지 폴트가 자주 발생한다면 한번에 올릴 페이지 수를 늘리고 페이지 폴트가 덜 발생한다면 한번에 올릴 페이지 수를 줄이는 알고리즘이다.




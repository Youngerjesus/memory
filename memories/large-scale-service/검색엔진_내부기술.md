# 검색엔진 내부 기술

### 먼저 역인덱스의 구조를 한번 보자.

- 역인덱스는 dictionary 와 postings 라는 두 부분으로 나눠져있다.
- dictionary 는 문서를 인덱스한 단어들이 있고 postings 에는 참조할 문서가 인덱스와 매핑되어 있다.

### 그러면 Dictionary 를 만드는 방법에 대해서 알아보자.

- dictionary 를 만든다는 건 term 을 어떻게 나누고 이를 찾을 것인지에 대한 문제인데 해결하는 방법은 다양하다.
- 미리 정해놓은 사전을 + 야호-코라식 알고리즘을 이용해서 term 을 나눌 수도 있고, 형태소를 분석해서 term  을 나눌 수도 있다. 그 다음 n-gram 이라는 방법을 사용해서 단어를 몇 글자로 쪼개서 term 으로 사용하는 방법도 있다.
- 영어의 경우에는 공백 (space) 를 기준으로 쪼개기만해도 term 이 구별된다. 하지만 일본어 같은 경우는 띄어쓰기가 없어서 이 방법을 사용하기는 힘들다. 그래서 앞서 말한 사전 + AC (야호-코라식) 이나 형태소 분석 기법을 사용한다.
- 이 방법들에 대해서 하나씩 살펴보자.

### 사전 + 야호-코라식 알고리즘을 이용해서 term 을 나누고 발견하는 방법

- 사전으로 쓸 단어는 Wikipeida 에 있는 단어들을 이용하면 된다. 그러면 60 만개의 단어들을 사전으로 만들어 두고 term 으로 쪼갤 때는 야호-코라식 알고리즘을 사용하면 된다.

### 형태소 분석을 하는 방법

- 형태소의 정의부터 보자. 형태소는 “**의미를 가지는 가장 작은 말의 단위**” 이다.
- 형태소 분석은 명사나 부사 같은 품사를 구별한 후 말에서 의미를 가장 작은 단위로 쪼개내는 것이다.
- 주로 이렇게 쪼개기 위해서는 형태소 분석기에 내부적으로 사전이 있어서 구별을 하거나, 기계학습등으로 패턴을 파악해서 분석하는 경우도 있다.
- 기계학습을 통해서 분석하는 경우는 뭐. 명사 다음에 조사가 온다거나, 조사와 동사사이에는 명사가 있다거나 이런 패턴을 학습해서 분류를 한다.

### 검색 누락

- 다음과 같은 예를 생각해보자.
- Gears of war 이라는 게임이 있다. 이 게임의 발매일을 알아보기 위해서 검색으로 “Gears 발매일” 이라고 생각하면 정확하게 발매일이 나온다.
- 이 경우에 Gears 는 term 으로 분리되어 있을 거니까 당연하다고 생각할 수 있다.
- 그럼 “Gear 발매일” 이라고 쿼리를 날리면 이것도 검색이 되야할끼?
- 이 부분은 해당 검색엔진을 만든 사람의 사상과 설계에 따라서 다른 부분이다.
- Gears 안에 Gear 이 포함되므로 해당 검색결과에 포함되어야 한다고 생각할 수 있고 Gear 는 Gears 와 똑같지 않으니까 검색결과에 포함되면 안된다고 주장할 수도 있다.
- 또 다른 문제로는 똑같은 원형의 단어로 인해서 조금씩 변형될 때 어떻게 해야할까? 를 고민해볼 수 있다.
- 이건 동의어 처리로 똑같은 term 으로 맞춰줘야 하는 작업이 필요하다고 생각한다.

### n-gram 으로 term 을 나누기

- n-gram 을 이용해서도 dictionary 에 사용될 term 을 만들 수 있다.
- n-gram 은 n 개의 단어를 쪼개서 term 으로 나누는 방식이다.
- 예를 들어 “애플워치 사고싶다.” 라는 문장을 2-gram 으로 나눈다고 생각해보면 “애플” “플워” “워치” “사고” “고싶” 싶다” 이렇게 될 것이다.
- 그리고 쿼리로 “애플워치” 가 들어오면 이것도 2-gram 으로 쪼개진다. 그렇게 쪼개진 term 과 연결된 문서들 중 교집합인 것이 있다면 그걸 가지고 온다. 이걸 영어에서는 intersction 이라고 부른다.
- 하지만 n-gram 도 문제가 있다. n-gram 으로 찾은 문서가 실제로 관련이 없느 문서를 찾을 수도 있다는 점이다.
- 예로보자. abxyz 와 bcopq 라는 문장을 2-gram 으로 넣었다. 그리고 쿼리는 abc 가 왔다. abc 는 해당 문장을 가진 문서를 찾을 것이다.
- 이렇게 잘못된 조회를 할 수 있기 때문에 n-gram 은 필터링 작업을 넣는 경우가 있다. 필터링 작업은 실제 문서 본문에 abc 가 있었는지를 조회하는 것이다.
- 이런 작업은 효과적이긴 하나 찾은 문서가 많았다면 시간이 오래걸리는 작업일 것이다.
- 그래서 일반적으로 n-gram 은 문장이 짧은 경우 (e.g 타이틀, 코멘트, URL 등에서 사용하고) 문서의 본문은 단어를 기반으로 한 역인덱스를 함께 사용하는 경우가 많다.

### 재현률 (Recall) 과 적합률 (Precision)

- 재현률과 적합률을 기반으로 검색엔진의 성능을 나타낸다.
- 재현률은 내가 찾는 전체 문서의 양 중에서 검색 결과는 얼만큼 양이 나왔는가 이고
- 적합률은 검색 결과로 나온 양 중에서 내가 찾는 문서의 비율은 얼마나 높은가? 이다.
- 한 쪽만 높다고 검색엔진의 성능이 좋지는 않다. 적합률만 높다면 검색 결과로 딱 하나만 보여주면 될 것이다. 재현률만 높다면 원하는 검색 결과는 다 나왔는데 거기에 쓰레기 문서의 비율도 많아서 원하는 정보를 주지 못할 수 있다.
- 좋은 검색엔진은 재현률이 높으면서 꽝이 없는 경우를 말한다.

### Postings 작성법

- postings 는 term 으로 찾을 수 있는 문서들이 배열로 연결될 것들을 말한다.
- 단순하게 문서 ID 만 있을 수도 있지만 문서 내 term 이 출현하는 위치를 포함시킬 수도 있다.
- 이를 Full Inverted Index 라고 부른다.
- 문서 내 term 이 출현하는 위치는 많은 유익한 정보를 줄 수 있어서 이를 기록하기도 한다.
    - snipet 을 뽑아낼 때, 스코어링을 매길 때, n-gram 을 이용하고 있다면 필터링을 매길 때 이렇게 한다.
    - 구글이 이러한 방식으로 스코어링을 매긴다.
- postings 에 문서 ID 만 저장 하는 인덱스를 Inverted File Index 라고 하며 가벼워서 관리하기 편하다는게 특징이다.
- 문서 ID 는 정렬된 형태로 관리할 것인데 이 경우에는 VB Code 로 압축하는게 가능하다.
- 인덱스 같은 경우는 자기들만의 key-value 스토어를 사용하는 경우가 많다.
- 메모리에 인덱스를 두는 경우에 응답이 가장 빠를 것인데 이 경우에 매번 어플리케이션이 스타트 할 때 인덱스를 만드는 작업을 할 것 이므로 외부 스토로지에 백업을 해두는 것이 좋다. 그러면 빠르게 로딩될 것이다.
- 여기서는 되게 간단하게만 다뤘는데 문서 ID 를 어떻게 순서를 매길 것인지, 압축 방법도 VB Code 말고 뭘 쓸것인지만 해도 논문이 된다.

### 스코어링에 대한 보충

- Google 의 PageRank 알고리즘은 스코어링 알고리즘 중 대표적이다.
- 이외에도 스코어링을 하는 알고리즘은 많다. BM25 (이거 맞나?) TF-IDF 를 이용한 알고리즘
    - 문서 내에서 중요한 단어의 경우 가산점을 많이 주는 알고리즘.

### 참고 문헌

- Algorithms on String
- Introduction to Information Retrieval
# OS 캐시와 분산

linux 에서는 디스크에서 읽어온 블록 (4KB) 는 가상 메모리 단위인 페이지에 할당된다.

- 페이지 단위로 할당 된다는 점으로 Page Cache 라고 불린다.
- Page Cache 는 남는 메모리가 있으면 적극적으로 사용한다. 대신에 프로세서가 메모리를 요구하면 캐시에 있는 메모리는 내려간다.

VFS (Virtual Fils System) 

- 디스크의 파일은 실제로는 드라이버에 의해서 가지고 오게되고 이 드라이버는 파일 시스템에 의해서 조작된다.
- 파일 시스템은 여러개가 있고 각각의 함수가 달라서 사용하기 불편한데 이를 추상화 해놓은게 VFS 이다.
- VFS 에 의해서 디스크 파일 입출력을 받고 페이지에 캐싱을 시킨다.

현재 메모리를 보고 싶다면 `var -r` 옵션을 하면 현재 사용하고 있는 메모리의 양과 캐시로 사용하고 있는 메모리의 양을 조회할 수 있다. 

- `%memusage` 가 실제로 사용하고 있는 메모리의 양
- `%kbcached` 가 캐시에 사용하고 있는 메모리의 양이다.
- `var -f /var/log/sa/sa05` 같은 옵션을 하면 특정 시간대의 메모리의 양을 조회하는게 가능하다.

### Page Cache 를 이용한 분산

- 메모리를 늘려서 모든 디스크에 있는 데이터를 메모리에 가지고 오던지.
- DB 를 나눌 경우 DB 마다 유지하고 있는 페이지 캐시를 다르게 하는 것.
    - 테이블을 기준으로 나누는 것도 가능 (인기 있는 것과 인기 없는 것 위주로)
        - 인기 있는 것은 A DB 로 인기 없는건 B DB 로 가도록
    - 하나의 테이블 내 파티션을 두는 것도 가능. (테이블에 있는 데이터가 엄청 큰 경우)
    - 요청 패턴을 보고 DB 를 나누는 것도 가능.
        - 응답속도가 중요하지 않은 요청 (봇에 의한 요청이라던지) 과 사용자에게 오는 요청을 분리시킨다던지.
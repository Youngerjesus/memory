# RealMongoDB 스토로지 엔진 

http://www.yes24.com/Product/Goods/58142119

***

## 플러그인 스토로지 엔진 

- 스토로지 엔진의 역할은 사용자의 데이터를 디스크와 메모리에 저장하고 가져오는 역할을 하는 것. 
- 몽고 DB 는 하나의 인스턴스에서 하나의 스토로지 엔진만 사용이 가능함. 
- 사용 가능한 스토로지 엔진은 다음과 같음.
  - MMAPv1
    - B-Tree
    - 캐시 사용: X
    - 세컨더리 인덱스: O
    - 데이터 압축: X
    - 인덱스 압축: X
    - 컬렉션 파티션: X
    - 암호화: X
    - In-Memory 지원: X
  - WiredTiger
    - B-Tree
    - 캐시 사용: O
    - 세컨더리 인덱스: O
    - 데이터 압축: O
    - 인덱스 압축: O
    - 컬렉션 파티션: X
    - 암호화: O
    - In-Memory 지원: O
  - RocksDB 
    - LSM
    - 캐시 사용: O
    - 세컨더리 인덱스: O
    - 데이터 압축: O
    - 인덱스 압축: O
    - 컬렉션 파티션: X
    - 암호화: X
    - In-Memory 지원: X
  - TouDB 
    - Fractal-Tree
    - 캐시 사용: O
    - 세컨더리 인덱스: O
    - 데이터 압축: O
    - 인덱스 압축: O
    - 컬렉션 파티션: O
    - 암호화: X
    - In-Memory 지원: X

### 몽고 DB 를 구성하는 컴포넌트 

- 클라이언트 드라이버 <-> 몽고 DB 통신은 Wire Protocol 을 통해서 통신한다. (네트워크 프로토콜)

## MMAPv1 스토로지 엔진 

- MMAPv1 스토로지 엔진은 내부 캐시가 없어서 운영체제 캐시에 의존한다. (page cache)
  - 이 페이지 캐시는 해당 리눅스에 따라서 다를 수도 있는데 리눅스에서 패이지 캐시 삭제 (cache invalidation) 문제가 생길 수 있다. 
  - 이건 갑자기 페이지 캐시가 사라지는 것임. 그래서 디스크에 부하가 갑자기 늘어날 수 있다.
  - 이 현상은 리눅스 서버의 응용 프로그램들 (MongoDB 포함) 이 더 많은 메모리를 필요로 하니까 여유분을 만들기 위해서 사라지게 한 것. 
- MMAPv1 스토로지 엔진은 데이터를 읽는 경우에 페이지 캐시를 먼저 뒤져본다. 
  - 리눅스에서는 페이지 캐시에 없으면 디스크에서 페이지를 읽는데 해당 페이지의 주변 페이지가 페이지 캐시에 있다면 Read-Ahead 알고리즘이 작동하게 되서 주변 페이지들도 모두 읽어서 같이 올린다.
  - Read-Ahead 알고리즘은 대량의 데이터를 읽을 때 성능을 올려줌.
  - 즉 4KB 페이지 하나를 읽는데 128KB 데이터를 읽어들이는 것.
  - 리눅스에서 확인할 떄는 `blockdev --getra /dev/sda` 명령을 통해서 확인이 가능함.
- MMAPv1 스토로지 엔진은 데이터를 쓰는 경우에 페이지 캐시에 먼저 내용을 변경하고 I/O 스케줄러가 알아서 디스크에 반영한다. 
  - `아직 디스크에 반영되기 전에 Mongo 가 죽으면 데이터 손실이 일어날 수 있기 떄문에 이 경우 write-ahead logging 을 저널에다가 한다.`
  - 페이지 캐시에서 변경이 된 내용을 더티 페이지라고 부른다. 
  - 이 더티 페이지들과 관련된 리눅스 파라미터는 다음과 같다. 
    - `vm.diry_writeback_centisecs = 500`
      - 5초마다 더티 페이지를 디스크로 플러쉬함.
    - `vm.dirty_expire_centisecs = 3000`
      - 30초 지난 페이지들을 디스크에 기록함.
    - `vm.dirty_ratio = 20`
      - 전체 메모리 중 20% 가 더티 페이지면 플러쉬를 시작함. 모든 연산을 멈추고.
    - `vm.dirty_background_ratio = 10`
      - 전체 메모리 중 10% 가 더티 페이지면 플러쉬를 시작함 백그라운드 스레드로. 
    - `vm.dirty_bytes = 0`
      - 해당 바이트를 넘어가면 더티 페이지를 플러쉬로 시작함. 모든 연산을 멈추고. 
    - `vm.dirty_background_bytes = 0`
      - 해당 바이트를 넘어가면 더티 페이지를 플러쉬로 시작함. 백그라운드 스레드로. 

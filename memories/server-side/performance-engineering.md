## 성능 엔지니어링 

성능 엔지니어링은 성능을 위한 목표를 정하고 이 목표를 위해서 계속해서 개선하는 작업을 하는 걸 말한다. 

### 성능 엔지니어링는 어떻게 하는가. 

#### 1. 분석 단계

성능의 요구사항을 정해야 한다. 몇 명의 동시 접속 유저까지 허용할껀지, 응답 시간은 어떻게 되는지, 시스템 접속의 총 유저 수는
얼마나 되는지 등등

또한 사용자의 서비스 이용 패턴을 파악해서 어느 시점에 부하가 몰리는지 등을 체크해야한다. 대부분의 성능은 피크 타임을 기준으로 
설계되기 떄문에. 

#### 2. 디자인 단계

분석 단계를 거친 후 목표 성능을 위해 디자인 하는 단계를 말한다. 디자인은 항상 피크 단계를 기준으로 말하며 최대 성능을 기준으로 
말한다.

이 단계에서는 하드웨어 수준이나 어떤 프레임워크, 미들웨어를 이용할지를 정해야 한다. 디자인 단계부터 이런 사항들을 고려해야한다.

예로 100,000 명 정도의 사용자를 기준이라면 RDBMS 를 사용할 수 있겠지만 1,000,000,000 대상의 유저를 기준으로 설계를 한다면 
NoSQL 과 같은 다른 차원의 미들웨어를 도입해야 한다.  

#### 3. 개발 단계 

개발 단계에서는 개발을 완료한 후 성능 테스트 한 후 목표했던 성능이 나오지 않는다면 계속해서 개발하는 단계를 말한다. 

#### 4. 최종 테스트 단계

이 단계에서는 최종 시스템의 성능과 미세 튜닝을 하는 수준으로 마무리 되어야 한다. 

이 과정에서는 실수로 잘못된 설정이 있는지 알아보고 이를 고치는 단계고 주로 미세 튜닝으로는 JVM 튜닝, 톰캣 튜닝, SQL 튜닝 등으로
성능을 뽑아내는 역할을 한다. 

#### 5. 운영 단계 

식스템이 운영 단계로 넘어가면 미처 발견하지 못했던 문제들을 발견할 수 있다, 그래서 지속적으로 모니터링 해서 성능을 감시해야한다. 

그리고 문제가 생겼을 때 이를 대비할 용량을 미리 준비해두거나 설계해두면 좋다. (Auto Scaling)

마지막으로 운영 단게에서 중요한게 로그를 수집하는 것인데 문제를 분석할 때 로그를 기반으로 분석하므로 로그를 잘 남겨두는게 좋다. 

로그를 남겨둘 떄 로그를 남기는 일로 인해 I/O 가 발생해 성능이 떨어질 수 있으므로 따로 로그 서버를 남겨놓고 비동기식으로 로그를 처리하는게 좋다. 

### 성능 테스트 절차 

#### 1. 먼저 목표와 모델을 정의한다. 

목표는 이전에 말했던 처리량이 기준이 될 수도 있고, 응답 시간이 기준이 될 수도 있다.  

모델은 주요 시나리오를 말한다. 

시나리오는 다음과 같을 수 있다.

- 로그인

- 사진 리스트

- 사진 업로드

- 사진 보기

- 사진 다운로드 

- 로그 아웃 

#### 2. 부하를 생성한다.

성능 모델을 만들었으면 이제 테스트를 해봐야하므로 부하를 직접 만든다. JMeter 같은 부하 툴이 있을 수 있고

대규모나 복잡한 부하를 원하면 nGrinder 같은 부하 툴을 쓸 수도 있다. 

#### 3. 테스트와 모니터링 

부하 테스트가 준비되면 실제로 부하를 주면서 모니터링하고 성능을 측정하고 병목 지점을 체크하면 된다.

주로 모니터링 포인트는 다음과 같다. 

- Application

  - 응답 시간(Response Time)과 처리량(TPS) 을 기준으로 성능을 측정하면 된다. 

- Middleware

  - WAS, RabbitMQ 같은 메시지 큐, MySQL 과 같은 데이터베이스 를 측정하면 된다.
  
  - WAS 같은 경우는 스레드 수와 큐의 길이가 1차 모니터링 대상이 된다. 서버가 처리할 수 있는 용량을 넘어서게 되면 
  스레드 수가 다 떨어질 것이고 이로인해 큐가 가득차게되면 메시지가 손실될 수 있다. 이 값은 JMX(Java Management Extension) API
  를 이용하면 모니터링 할 수 있다. 
  
  - Database 같은 경우는 slow-query 가 나가면 로그가 쌓이게 되는데 이를 실행계획을 통해서 분석하면 된다. 
   
- Infrastructure

  - Infrastructure 는 하드웨어 구간에서 병목이 생기지 않는지 체크하는 것이다.
  
  - CPU 같은 경우는 목표 성능이 나올 때 CPU 의 70% 미만으로 차지하고 있는지 검사하면 된다. 
  
  - 메모리 같은 경우는 JVM 위에서 동작하는 프로세스의 경우에는 크게 메모리 사용량이 변하지 않는다.
  다만 모니터링 할 점은 JVM 같은 경우 스왑을 할 경우에 급격히 성능이 떨어지기 때문에 스왑을 하는지 체크하는게 중요하다. 
  

### 튜닝(Tuning)

병목 지점을 찾았으면 이를 이제는 해결하면 된다.

해결하는 기본 접근 방법은 다음과 같다.

#### 1. 문제의 정의

문제 정의는 구체적으로 하는게 좋다. 그냥 느리다. 이런 것 보다는 CPU 가 100% 차지하고 있다 등

응답 시간이 2초를 넘어가고 있다 등 구체적이어야 하며 문제를 테스트할 수 있도록 재현이 가능해야 한다. 

#### 2. Break down 

문제가 어디서 발생하는지 찾는 과정이다. 로드 밸런서에서 발생하는지 어플리케이션이나 미들웨어에서 발생하는지 데이터베이스에서
발생하는지 정확하게 어디서 발생하는지 찾기 위한 과정으로 어떤 컴포넌트를 지나치는지 명확하게 분리해서 알고 있어야 한다. 

#### 3. Isolation

문제가 되는 구간을 고립시키고 나머지 컴포넌트는 Mocking 을 해서 테스트를 해보는 걸 말한다. 

이를 통해서 정확히 문제가 어디서 발생하는지 테스트 할 수 있다. 

#### 4. Narrow down

어떤 컴포넌트에서 발생했는지 알았다면 이제 해당 컴포넌트를 타고 가면서 어디서 문제가 발생하는지 알아봐야 한다. 

프로파일링 하거나 코드를 디버깅 하는 듯 문제의 원인을 분석하는 과정을 Narrow Down 이라고 한다. 

#### 5. Bottleneck 발견 

Narrow Down 을 하다 보면 근본적인 문제점을 발견하게 된다. 

#### 6. 해결  

병목의 원인을 찾았으니 해결하면 되는데 해결하기 쉬운 문제일 수도 있지만 근본적인 설계의 문제라면 문제를 해결하기 어려울 수 있다.

근본적인 솔루션을 해결하기 어렵다면 다른 방식을 통해서 해결하는 것도 고려해봐야한다. 예를 들면 로그인 솔루션의 시간을 단축시키기 어렵다면
UX 상으로 모래 시계를 보여줘서 무엇인가가 제대로 동작하고 있다는 걸 알려주는 등의 행위를 말한다. 
 
 



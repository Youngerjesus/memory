# TCP 연결 관리 

학습 목표 
- 연결이 맺어지고 끊기는 것에 대해서 좀 더 자세하게 
- 언제 끊어지는지. 
- HTTP KeepAlive 와 TCP KeepAlive

## 연결의 시작 

- 3-way-handshake 는 3개의 세그먼트가 초기 연결에 쓰인다고 해서 쓰여짐.
  - 1) 클라이언트 프로세스가 연결을 원하는 서버 프로세스에게 연결을 하자고 보냄.
    - SYN 패킷을 보낸거고 상태는 `SYN_SENT` 가 된다. 
  - 2) 서버 프로세스가 좋다고 응답을 보냄. 
    - 클라이언트 입장에서는 ACK 와 SYN 패킷을 수신한 상태가 된다. 
  - 3) 클라이언트 프로세스가 그 응답을 받고 데이터를 보냄.
    - 서버쪽 응답을 받았고 ACK 를 보낸 상태가 되고 연결이 된 `ESTABILSHED` 가 된다. 

## TCP 구조에서 플래그 필드

- TCK 패킷의 종류를 구별하는 필드  
  - CWR
  - ECE
    - CWR 과 ECE 는 Congestion Control 과 관련된 필드 
  - URG
    - 송신 층 상위 계층이 긴급으로 표시하는 데이터라는 뜻이다.
    - 이때 긴급 데이터는 긴급 데이터 포인트 필드 (Urgent data point field) 에 의해서 가려진다. 
  - ACK
    - 응답 
  - PSH
    - 수신자가 데이터를 즉시 상위 계층에게 전달해야 한다는 걸 가리킴. 
  - RST
    - 연결 Reset. 이미 끊겨진 연결로 누군가 데이터를 보냈을 때 소켓이 준비되어있지 않으니 보내지 마라. 라는 뜻.  
  - SYN
    - 연결 시작할 때 
  - FIN 
    - 연결 종료할 때 

## 연결 종료 

- 1) 연결을 종료하고 싶은 클라이언트 프로세스가 FIN 패킷을 보낸다. 
  - 상태는 `FIN_WAIT_1` 이 된다. 
  - 서버 프로세스는 이때 `CLOSED_WAIT` 가 되고 ACK 를 보낸다. 
  2) 서버 프로세스로부터 확인 응답인 ACK 와 종료를 의미하는 FIN 패킷을 전달받는다. 
  - 상태는 `FIN_WAIT_2` 가 된다. 
  - 서버 프로세스는 `FIN` 패킷을 보내고 `LAST_ACK` 상태가 된다.
  3) 클라이언트 프로세스는 ACK 를 보낸다 .
  - 상태는 `TIME_WAIT` 가 되고 30초를 기다렸다가 `CLOSED` 라는 상태가 된다.
  - 서버 프로세스는 `ACK` 를 받으면 `CLOSED` 가 된다. 

- 현실 상황에서는 `FIN` 패킷을 보내지 못하고 종료되는 경우도 많다고 한다. 예로 스위치를 뽑아버리는 경우. 
  - 그럼 뭐 데이터 전달하고 ACK 가 안오니까 에러를 던지면서 알겠지.

## Question 

- Connection Pool 에서 Connection 을 가지고 왔을 때 TCP connection 이 닫힌 상태로 가지고 왔을 수 있나?
  - 한쪽만 일방적으로 닫히는 건 가능하다. 그리고 커넥션을 가지고 올 때 유효한지 체크한다.
  - 물론 가지고 와서 쓰고있는 중에 닫힐 수도 있다. 이 경우엔 에러를 내뱉음. 
    - 근데 시그널 없이 한쪽만 닫히는 경우도 있다고 한다. 이게 `half-close` 라고 하는 것 같은데. 이때는 읽어왔을 때 발생하는 에러로 밖에 알 수 없음.
      - 이건 TCP Keep-alive 를 쓸 때 가능하다고 함. 
        - KeepAlive probe 와 interval 을 통해서 주기적으로 연결되어있는 상태를 감지하는데 그 전에 닫힌 경우라면 알지 못함. 즉 닫혔는데 실시간으로 알지 못한다.  

## TCP KeepAlive 

- TCP KeepAlive 는 클라이언트-서버 중 한쪽만 써도 된다.

## TCP KeepAlive vs HTTP KeepAlive

- TCP KeepAlive 는 TCP connection 이 계속 유지되어있는지 확인하는 것.
- HTTP KeepAlive 는 하나의 request 를 같은 TCP Connection 에서 보낼 수 있는지 확인하는 것.
- HTTP KeepAlive 는 최대한 시간만큼 연결을 유지한다.
- 이 값을 60초로 지정해두면 TCP 는 60초마다 연결을 확인하고, HTTP 는 60초 지나면 연결을 끊는다. 
